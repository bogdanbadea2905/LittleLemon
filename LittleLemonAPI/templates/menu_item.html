{% extends 'base.html' %} {% load static %} {% block content %}
<section>
  <article>
    <h1>Menu item</h1>
    <span id="breadcrumb">
      <a href="{% url 'home' %}">Home</a> /
      <a href="{% url 'menu' %}">Menu</a> /
      <span id="item-name-breadcrumb">Loading...</span>
    </span>

    <!-- Loading state -->
    <div id="loading-container">
      <p>Loading menu item...</p>
    </div>

    <!-- Error state -->
    <div id="error-container" style="display: none">
      <p style="color: red">
        Error loading menu item. <a href="{% url 'menu' %}">Return to menu</a>
      </p>
    </div>

    <!-- Menu item content -->
    <div id="menu-item-content" style="display: none">
      <!--Begin row-->
      <div class="row">
        <!--Begin col-->
        <div class="column">
          <h2 id="item-title">Menu Item Title</h2>
          <p id="item-description">Menu item description</p>
          <p id="item-price">Price: $0.00</p>
          <div id="item-additional-info" style="margin-top: 15px; color: #666">
            <p>Category: <span id="item-category">N/A</span></p>
            <p>In Stock: <span id="item-inventory">0</span></p>
          </div>

          <!-- Manager controls (if user has permissions) -->
          <div id="manager-controls" style="margin-top: 20px; display: none">
            <h3>Manager Controls</h3>
            <button
              id="edit-btn"
              style="
                margin-right: 10px;
                padding: 10px 15px;
                background-color: #007cba;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
              "
            >
              Edit Item
            </button>
            <button
              id="delete-btn"
              style="
                padding: 10px 15px;
                background-color: #dc3545;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
              "
            >
              Delete Item
            </button>
          </div>

          <!-- Edit form (hidden by default) -->
          <div
            id="edit-form"
            style="
              display: none;
              margin-top: 20px;
              padding: 20px;
              background-color: #f8f9fa;
              border-radius: 5px;
            "
          >
            <h3>Edit Menu Item</h3>
            <form id="menu-item-form">
              <div style="margin-bottom: 15px">
                <label for="edit-title">Title:</label><br />
                <input
                  type="text"
                  id="edit-title"
                  style="width: 100%; padding: 8px; margin-top: 5px"
                />
              </div>
              <div style="margin-bottom: 15px">
                <label for="edit-description">Description:</label><br />
                <textarea
                  id="edit-description"
                  rows="4"
                  style="width: 100%; padding: 8px; margin-top: 5px"
                ></textarea>
              </div>
              <div style="margin-bottom: 15px">
                <label for="edit-price">Price:</label><br />
                <input
                  type="number"
                  id="edit-price"
                  step="0.01"
                  style="width: 100%; padding: 8px; margin-top: 5px"
                />
              </div>
              <div style="margin-bottom: 15px">
                <label for="edit-inventory">Inventory:</label><br />
                <input
                  type="number"
                  id="edit-inventory"
                  style="width: 100%; padding: 8px; margin-top: 5px"
                />
              </div>
              <div>
                <button
                  type="submit"
                  style="
                    padding: 10px 15px;
                    background-color: #28a745;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    margin-right: 10px;
                  "
                >
                  Save Changes
                </button>
                <button
                  type="button"
                  id="cancel-edit"
                  style="
                    padding: 10px 15px;
                    background-color: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                  "
                >
                  Cancel
                </button>
              </div>
            </form>
          </div>
        </div>
        <!--End col-->
        <!--Begin col-->
        <div class="column">
          <img
            id="item-image"
            src=""
            alt=""
            style="max-width: 100%; height: auto; border-radius: 5px"
          />
        </div>
        <!--End col-->
      </div>
      <!--End row-->
    </div>
  </article>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get menu item ID from URL
    const pathParts = window.location.pathname.split("/");
    const menuItemId =
      pathParts[pathParts.length - 2] || pathParts[pathParts.length - 1];

    if (!menuItemId || isNaN(menuItemId)) {
      showError();
      return;
    }

    loadMenuItem(menuItemId);

    // Event listeners for manager controls
    document.getElementById("edit-btn").addEventListener("click", showEditForm);
    document
      .getElementById("cancel-edit")
      .addEventListener("click", hideEditForm);
    document
      .getElementById("delete-btn")
      .addEventListener("click", deleteMenuItem);
    document
      .getElementById("menu-item-form")
      .addEventListener("submit", updateMenuItem);
  });

  let currentMenuItemId = null;
  let currentMenuItemData = null;

  function loadMenuItem(id) {
    currentMenuItemId = id;

    fetch(`/menu-items/${id}/`)
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        currentMenuItemData = data;
        displayMenuItem(data);
        checkManagerPermissions();
      })
      .catch((error) => {
        console.error("Error fetching menu item:", error);
        showError();
      });
  }

  function displayMenuItem(item) {
    // Hide loading, show content
    document.getElementById("loading-container").style.display = "none";
    document.getElementById("menu-item-content").style.display = "block";

    // Update content
    document.getElementById("item-name-breadcrumb").textContent =
      item.title || item.name || "Unknown Item";
    document.getElementById("item-title").textContent =
      item.title || item.name || "Unknown Item";
    document.getElementById("item-description").textContent =
      item.menu_item_description ||
      item.description ||
      "No description available";
    document.getElementById("item-price").textContent = `Price: ${parseFloat(
      item.price || 0
    ).toFixed(2)}`;
    document.getElementById("item-category").textContent = item.category
      ? item.category.title
      : "N/A";
    document.getElementById("item-inventory").textContent = item.inventory || 0;

    // Update image with error handling
    const img = document.getElementById("item-image");
    const itemName = item.title || item.name || "";
    img.src = `/Users/bodo/Documents/CursPython/LittleLemon/LittleLemonAPI/static/img/${itemName}.jpg`;
    img.alt = itemName;

    // Set up error handling for image
    img.onerror = function () {
      this.src = "{% static 'img/no-image.jpg' %}";
      this.onerror = null; // Prevent infinite loop if default image also fails
    };
  }

  function showError() {
    document.getElementById("loading-container").style.display = "none";
    document.getElementById("error-container").style.display = "block";
  }

  function checkManagerPermissions() {
    // This would typically check user permissions
    // For now, we'll show manager controls if the user can access them
    // You might want to make a separate API call to check permissions

    // Temporary: try to make a test request to see if user has manager permissions
    fetch(`/menu-items/${currentMenuItemId}/`, {
      method: "HEAD", // Just check headers without getting the full response
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => {
        // If user can access the API endpoint, show manager controls
        // This is a simplified check - you might want to implement proper permission checking
        if (response.ok) {
          document.getElementById("manager-controls").style.display = "block";
        }
      })
      .catch((error) => {
        // If there's an error, don't show manager controls
        console.log("No manager permissions or error checking permissions");
      });
  }

  function showEditForm() {
    const form = document.getElementById("edit-form");
    const data = currentMenuItemData;

    // Populate form with current data
    document.getElementById("edit-title").value = data.title || data.name || "";
    document.getElementById("edit-description").value =
      data.menu_item_description || data.description || "";
    document.getElementById("edit-price").value = data.price || "";
    document.getElementById("edit-inventory").value = data.inventory || "";

    form.style.display = "block";
    document.getElementById("edit-btn").style.display = "none";
  }

  function hideEditForm() {
    document.getElementById("edit-form").style.display = "none";
    document.getElementById("edit-btn").style.display = "inline-block";
  }

  function updateMenuItem(event) {
    event.preventDefault();

    const formData = {
      title: document.getElementById("edit-title").value,
      menu_item_description: document.getElementById("edit-description").value,
      price: parseFloat(document.getElementById("edit-price").value),
      inventory: parseInt(document.getElementById("edit-inventory").value),
    };

    fetch(`/menu-items/${currentMenuItemId}/`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCsrfToken(),
      },
      body: JSON.stringify(formData),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to update menu item");
        }
        return response.json();
      })
      .then((data) => {
        currentMenuItemData = data;
        displayMenuItem(data);
        hideEditForm();
        alert("Menu item updated successfully!");
      })
      .catch((error) => {
        console.error("Error updating menu item:", error);
        alert("Error updating menu item. Please try again.");
      });
  }

  function deleteMenuItem() {
    if (
      !confirm(
        "Are you sure you want to delete this menu item? This action cannot be undone."
      )
    ) {
      return;
    }

    fetch(`/menu-items/${currentMenuItemId}/`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": getCsrfToken(),
      },
    })
      .then((response) => {
        if (response.ok) {
          alert("Menu item deleted successfully!");
          window.location.href = "{% url 'menu' %}";
        } else {
          throw new Error("Failed to delete menu item");
        }
      })
      .catch((error) => {
        console.error("Error deleting menu item:", error);
        alert("Error deleting menu item. Please try again.");
      });
  }

  function getCsrfToken() {
    // Get CSRF token from cookie or meta tag
    const cookieValue = document.cookie
      .split("; ")
      .find((row) => row.startsWith("csrftoken="))
      ?.split("=")[1];

    if (cookieValue) {
      return cookieValue;
    }

    // Alternative: get from meta tag
    const csrfMeta = document.querySelector("[name=csrfmiddlewaretoken]");
    return csrfMeta ? csrfMeta.content : "";
  }
</script>
{% endblock %}
